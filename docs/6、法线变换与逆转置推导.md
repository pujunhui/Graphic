## 法线变换与逆转置推导

本文说明在顶点着色阶段为何对法线使用模型矩阵的逆矩阵的转置（inverse-transpose），以及为何将法线以齐次向量的 w 设为 0。

### 1. 背景与问题

渲染时，顶点位置通常以 $4\times4$ 仿射矩阵进行变换：
$$ x' = M x $$
其中 $M$ 是模型矩阵（可能包含旋转 R、缩放 S、平移 t），$x$ 为位置的齐次坐标 $(x, y, z, 1)$。

法线向量 $n$ 描述了一个平面的方向。顶点位置的仿射变换若直接用于法线，会在非均匀缩放时破坏其与切线空间的正交关系，导致光照错误。因此我们需要专门的法线变换公式。

### 2. 从平面不变量推导逆转置

将三维平面记为：
$$ n^T x = c $$
对任意在平面上的点 $x$ 都满足此等式。若对空间施加线性（或仿射）变换 $x' = A x$（此处先忽略平移分量，只考虑 $3\times3$ 线性部分 $A$），我们希望在变换后仍能用某个 $n'$ 描述同一平面：
$$ n'^T x' = c' \quad \text{对所有在原平面上的 } x $$
代入 $x' = A x$：
$$ n'^T A x = c' $$
要使对所有满足 $n^T x = c$ 的 $x$ 都成立，必须有（对于法向量部分的同构）：
$$ n' = (A^{-1})^T n $$

这就是“逆矩阵的转置”的来源：当位置按 $A$ 变换时，使平面不变量保持的法线应按 $(A^{-1})^T$ 变换。

当模型矩阵 $M$ 含有平移时，可将其分解为：
$$ M = \begin{bmatrix} A & t \\ 0 & 1 \end{bmatrix} $$
其中 $A$ 是 $3\times3$ 的线性部分（旋转与缩放），$t$ 为平移向量。法线只受 $A$ 影响，不受 $t$ 影响（见第 4 节），故仍使用 $(A^{-1})^T$。

特别地：
- 若 $A$ 为正交矩阵（仅旋转，无缩放），则 $A^{-1} = A^T$，逆转置退化为原矩阵本身（$ (A^{-1})^T = A $）。
- 若存在非均匀缩放，必须使用逆转置，否则法线方向将被错误压缩/拉伸。

### 3. 实际实现（4×4 齐次形式）

在代码中常以 $4\times4$ 的模型矩阵参与计算。将法线扩展为齐次向量时，应取 $w=0$：
$$ n_{h} = (n_x, n_y, n_z, 0) $$
计算时可直接对 $4\times4$ 矩阵取逆再转置：
$$ n'_{h} = (M^{-1})^T \; n_{h} $$
随后取前三维作为新法线并做单位化（normalize）。许多实现也仅对 $M$ 的左上 $3\times3$ 子矩阵进行逆转置，再与三维法线相乘。

伪代码示意：
```cpp
// 模型矩阵: mModelMatrix (4x4)
// 顶点法线: normal (vec3)
auto normalMatrix = transpose(inverse(mModelMatrix));
vec3 transformedNormal = normalize((normalMatrix * vec4(normal, 0.0f)).xyz);
```

### 4. 为何法线 w 要设为 0

齐次坐标中，$w=1$ 表示点，$w=0$ 表示方向（向量）。仿射变换矩阵 $M = \begin{bmatrix} A & t \\ 0 & 1 \end{bmatrix}$ 作用于齐次向量 $v_h$ 时：

- 若 $v_h = (v, 1)$（点）：$M v_h = (A v + t, 1)$，会受到平移 $t$ 的影响。
- 若 $v_h = (v, 0)$（方向）：$M v_h = (A v, 0)$，不会受到平移影响，仅受线性部分 $A$ 影响。

法线是方向，不应被平移。因此以 $w=0$ 乘以逆转置后的矩阵，既可避免错误引入平移，又与第 2 节的理论推导一致（只需考虑线性部分 $A$）。

### 5. 何时需要逆转置，何时可以简化

- 仅旋转（正交矩阵）：可直接用 $R$ 变换法线；因为 $(R^{-1})^T = R$。
- 含均匀缩放（$sI$）：$(sI)^{-1}\! = \tfrac{1}{s}I$，逆转置与线性缩放方向一致，仍建议使用逆转置以保持统一。
- 含非均匀缩放/剪切：必须使用逆转置，否则光照会明显错误。

### 6. 数值与实现细节

- 变换后请进行单位化：$n' = \mathrm{normalize}(n')$。
- 避免每顶点重复求逆：可在 CPU 侧或每 Draw 调用处预计算法线矩阵 $N = (M^{-1})^T$。
- 若矩阵可能奇异（不可逆），需在内容制作或变换组合上规避奇异情况；或在代码中做容错处理。

### 7. 小结

- 理论根基：平面不变量 $n^T x = c$ 在变换 $x' = A x$ 下保持，推出 $n' = (A^{-1})^T n$。
- 工程做法：对模型矩阵取逆转置，法线以 $w=0$ 的齐次向量参与计算，仅受线性部分影响；最后单位化。


